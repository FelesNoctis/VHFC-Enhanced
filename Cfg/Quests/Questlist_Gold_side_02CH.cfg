#TD1
Ch2_TD_elso
{
	Chapter=2
	Rewards=Gold(1000),XP(1000),RandomItem(rarity:rare)
	Task
	{
		TaskID=Report
		State=inactive
	}
	Stage0
	{
		State=Inactive		
		OnStoryData:Generator_quest_done,keep
		{
			SetStage=5
		}
	}
	Stage5
	{
		State=Inactive
		Mark=new,terep_Lair,Factory_engineer1,npc
		OnStoryData:TD1_personally,keep
		{
			SetStage=10
		}
		OnStoryData:NO_TD1,keep
		{
			SetStage=25
		}		
	}
	Stage10
	{
		State=Active
		Mark=target,terep_Lair,lair_generator_waypoint,dummy,main
		OnSet
		{				
			EnableWaypoint=terep_VHGold_TD1;TD1_waypoint,true
		}
		OnMapChanged:terep_VHGold_TD1
		{
			SetStage=14
		}		
	}
	Stage14
	{
		State=Active
		OnStoryData:TD1_failed,keep
		{
			SetStage=17
		}
		OnStoryData:TD1_success,keep
		{
			SetStage=17
		}
	}
	Stage17
	{
		State=Active
		Mark=target,terep_VHGold_TD1,Entrance_from_fields,dummy,Report
		OnSet
		{
			HasStoryData:TD1_success,equal,1
			{
				SetTaskState=main,Completed
			}
			HasStoryData:TD1_failed,equal,1
			{
				SetTaskState=main,Failed
			}
			SetTaskState=Report,Active			
		}
		OnMapChanged:terep_Lair
		{			
			SetStage=20
		}
	}
	Stage20
	{
		State=Active
		Mark=Completed,terep_Lair,Factory_engineer1
		OnSet
		{				
			EnableWaypoint=terep_VHGold_TD1;TD1_waypoint,false			
		}
		OnStoryData:TD1_reported,keep
		{
			HasStoryData:TD1_success,equal,1
			{
				SetStage=21
			}	
			HasStoryData:TD1_failed,equal,1
			{
				SetStage=22
			}		
		}
	}
	Stage21
	{		
		State=Completed
		OnSet
		{			
			RemoveStoryData=TD1_personally
			RemoveStoryData=TD1_success
			RemoveStoryData=TD1_failed					
		}
	}
	Stage22
	{		
		State=Failed
		OnSet
		{			
			RemoveStoryData=TD1_personally
			RemoveStoryData=TD1_success
			RemoveStoryData=TD1_failed					
		}
	}
	Stage25
	{		
		State=Hidden
	}
}
Ch2_Lost_in_the_Ink
{
	Chapter=2
	Rewards=Gold(2000),XP(4000)
	Stage0
	{
		State=Inactive
		OnMapChanged:terep_ink_monsta
		{
			SetStage=5
		}
	}
	Stage5
	{
		State=Active
		OnStoryData:BloodRabbit_beaten,keep
		{
			AddStoryData=This_is_dangerous_monster
		}
		OnMapChanged:terep_lair
		{
			SetStage=10
		}
	}
	Stage10
	{
		State=Completed
	}
}
Ch2_Witch_Ritual
{
	Chapter=2
	Rewards=Gold(2000),XP(5000)
	Task
	{
		TaskID=speak_witch
		State=Inactive
	}
	Task
	{
		TaskID=return
		State=Inactive
	}
	Stage0
	{
		State=Inactive
		OnStoryData:Gas_machine_quest_begin,keep
		{
			SetStage=5
		}
	}
	Stage5
	{
		State=Inactive
		Mark=new,terep_lair,Saffi,npc
		OnStoryData:Rat_bones_quest_begin,keep
		{
			SetStage=10
		}
		OnItemGot:Rat_bone
		{
			SetStage=8
		}
	}
	Stage8
	{
		State=Active
		Optional=1
		Mark=completed,terep_lair,Saffi,npc,speak_witch
		OnSet
		{
			AddStoryData=Lair_witch_1
			AddStoryData=First_rat_bone
			SetTaskState=main,Hidden
			SetTaskState=speak_witch,Active
		}
		OnStoryData:Rat_bones_quest_begin,keep
		{
			SetStage=10
			SetTaskState=main,Active
			SetTaskState=speak_witch,Completed
		}
		OnItemGot:Rat_bone
		{
			ItemCount:Rat_bone,greater_equal,5
			{
				SetTaskState=main,Completed
				AddStoryData=Fifth_rat_bone
				AddStoryData=Lair_witch_2
			}
		}
		OnStoryData:Rat_bones_quest_Done,keep
		{
			SetStage=9
		}
	}
	Stage9
	{
		State=Completed
	}
	Stage10
	{
		State=Active
		OnItemGot:Rat_bone
		{
			ItemCount:Rat_bone,greater_equal,5
			{
				SetStage=15
			}
		}
	}
	Stage15
	{
		State=Active
		Mark=completed,terep_lair,Saffi,npc,return
		OnSet
		{
			AddStoryData=Five_rat_bones_collected
			SetTaskState=main,Completed
			SetTaskState=return,Active
		}
		OnStoryData:Rat_bones_quest_Done,keep
		{
			SetStage=20
		}
	}
	Stage20
	{
		State=Completed
	}
}

Ch2_Water_Maffia
{
	Chapter=2
	Rewards=Gold(2000),XP(5000),RandomItem(rarity:rare),AbilityPoint(1)
	Task
	{
		TaskID=return
		State=Inactive
	}
	Stage0
	{
		State=Inactive
		OnStoryData:Gas_machine_quest_begin,keep
		{
			SetStage=5
		}
	}
	Stage5
	{
		State=Inactive
		Mark=new,terep_viztisztito_1,varoslako_1,npc
		OnStoryData:Water_mafia_quest_begin,keep
		{
			SetStage=10
		}
		OnSoldierGroupKilled:Water_mafia,terep_viztisztito_1
		{
			SetStage=7
		}
		OnStoryData:Water_mafia_quest_failed
		{
			SetStage=8
		}
	}
	Stage7
	{
		Optional=1
		State=Inactive
		OnSet
		{
			AddStoryData=Water_mafia_destroyed
		}
	}
	Stage8
	{
		Optional=1
		State=Inactive
	}
	Stage10
	{
		State=Active
		Mark=target,terep_viztisztito_1,Water_mafia_location,dummy,main
		OnSoldierGroupKilled:Water_mafia,terep_viztisztito_1
		{
			SetStage=15
		}`
	}
	Stage15
	{
		State=Active
		Mark=completed,terep_viztisztito_1,varoslako_1,npc,return
		OnSet
		{
			SetTaskState=main,Completed
			SetTaskState=return,Active
			AddStoryData=Water_mafia_destroyed
		}
		OnStoryData:Water_mafia_quest_done,keep
		{
			SetStage=20
		}
	}
	Stage20
	{
		State=Completed
	}
}

Ch2_The_Dark_Alchemist
{
	Chapter=2
	Rewards=Gold(2000),XP(2500),RandomItem(rarity:rare)
	Task
	{
		TaskID=destroy
		State=Inactive
	}
	Task
	{
		TaskID=kill
		State=Inactive
	}
	Task
	{
		TaskID=return
		State=Inactive
	}
	
	Stage0
	{
		State=Inactive
		OnSoldierGroupKilled:Killer_ghouls,terep_viztisztito_1
		{
			SetStage=5
		}
	}
	Stage5
	{
		State=Inactive
		Mark=new,terep_viztisztito_1,Varoslako_2,npc
		OnSet
		{
			HasStoryData:Dark_Alchemist_begin,equal,1
			{
				SetStage=10
			}
		}
		OnStoryData:Dark_Alchemist_begin,keep
		{
			SetStage=10
		}
	}
	Stage10
	{
		State=Active
		OnSet
		{
			AddStoryData=Spawn_Merchant
			HasStoryData:Spawn_Merchant_Lair,equal,1
			{
				Mark=target,terep_lair,Fence,npc,main
			}
			HasStoryData:Spawn_Merchant_Lair,equal,0
			{
				Mark=target,terep_viztisztito_1,Fence,npc,main
			}
			HasStoryData:Rusty_bomb_done,equal,1
			{
				SetStage=15
			}
		}
		OnStoryData:Spawn_Merchant_Done,keep
			{
				HasStoryData:Spawn_Merchant_Lair,equal,1
				{
					Mark=target,terep_lair,Fence,npc,main
				}
				HasStoryData:Spawn_Merchant_Lair,equal,0
				{
					Mark=target,terep_viztisztito_1,Fence,npc,main
				}
			}
		OnStoryData:Rusty_bomb_done,keep
		{
			SetStage=15
		}
	}
	Stage15
	{
		State=Active
		Mark=target,terep_viztisztito_1,Destroy_the_outflow,dummy,destroy
		OnSet
		{
			Mark=none,terep_lair,Fence,npc,main
			Mark=none,terep_viztisztito_1,Fence,npc,main
			SetTaskState=main,Completed
			SetTaskState=destroy,Active
			HasStoryData:Outflow_destroyed,equal,1
			{
				SetStage=20
			}
		}
		OnStoryData:Outflow_destroyed,keep
		{
			SetStage=20
		}
	}
	Stage20
	{
		State=Active
		OnSet
		{
			SetTaskState=destroy,Completed
			SetTaskState=kill,Active
			SpawnMonster=Dark_alchemist,Dark_alchemist,terep_viztisztito_1,Dark_Alchemist_own
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location2
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location2
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location2
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location2
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location2
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location2
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location3
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location3
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location3
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location3
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location3
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location3
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location3
			SpawnMonster=Ghoul_nagyrange,Ghoul_nagyrange,terep_viztisztito_1,Dark_Alchemist_location3
		}
		OnSoldierKilled:Dark_alchemist,terep_viztisztito_1
		{
			SetStage=25
		}
	}
	Stage25
	{
		State=Active
		Mark=completed,terep_viztisztito_1,Varoslako_2,npc
		OnSet
		{
			SetTaskState=kill,Completed
			SetTaskState=return,Active
			AddStoryData=Dark_Alchemist_dead
		}
		OnStoryData:Dark_Alchemist_quest_Done,keep
		{
			SetStage=30
		}
	}
	Stage30
	{
		State=Completed
	}
}

Ch2_Monster_Hunting
{
	Chapter=2
	Rewards=Gold(2000),XP(5000),RandomItem(rarity:rare),AbilityPoint(1)
	Task
	{
		TaskID=return
		State=Inactive
	}
	Stage0
	{
		State=Inactive
		OnStoryData:Monsters_hunting_begin,keep
		{
			SetStage=5
		}
		OnStoryData:Monsters_hunting_failed,keep
		{
			SetStage=3
		}
	}
	Stage3
	{
		State=Hidden
	}
	Stage5
	{
		State=Active
		OnSet
		{
			SpawnMonster=Mouthbeast,Hunted_monster1,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Mouthbeast,Hunted_monster1,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Mouthbeast,Hunted_monster1,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_1
			SpawnMonster=Mouthbeast,Hunted_monster2,terep_viztisztito_1,City_monsters_2
			SpawnMonster=Mouthbeast,Hunted_monster2,terep_viztisztito_1,City_monsters_2
			SpawnMonster=Mouthbeast,Hunted_monster2,terep_viztisztito_1,City_monsters_2
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_2
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_2
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_2
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_2
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_2
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_2
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_2
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_2
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_2
			SpawnMonster=Ghoul,Ghoul,terep_viztisztito_1,City_monsters_2
			Mark=target,terep_viztisztito_1,City_monsters_1,dummy,main
			Mark=target,terep_viztisztito_1,City_monsters_2,dummy,main
		}
		OnSoldierKilledName:Hunted_monster1,terep_viztisztito_1
		{
			CountSoldiers=terep_viztisztito_1,Hunted_monster1,Hunted_monster1,name
		}
		OnVariableChanged:Hunted_monster1,0
		{
			Mark=none,terep_viztisztito_1,City_monsters_1,dummy,main
			AddStoryData=Hunted_monster1_dead
		}
		OnSoldierKilledName:Hunted_monster2,terep_viztisztito_1
		{
			CountSoldiers=terep_viztisztito_1,Hunted_monster2,Hunted_monster2,name
		}
		OnVariableChanged:Hunted_monster2,0
		{
			Mark=none,terep_viztisztito_1,City_monsters_2,dummy,main
			AddStoryData=Hunted_monster2_dead
		}
		OnStoryData:Hunted_monster1_dead,keep
		{
			HasStoryData:Hunted_monster2_dead,equal,1
			{
				SetStage=10
			}
		}
		OnStoryData:Hunted_monster2_dead,keep
		{
			HasStoryData:Hunted_monster1_dead,equal,1
			{
				SetStage=10
			}
		}
	}
	Stage10
	{
		State=Active
		Mark=completed,terep_viztisztito_1,Varoslako_2,npc,return
		OnSet
		{
			SetTaskState=main,Completed
			SetTaskState=return,Active
			AddStoryData=All_city_monsters_dead
		}
		OnStoryData:City_NPC_quests_done,keep
		{
			SetStage=15
		}
	}
	Stage15
	{
		State=Completed
	}
}

Ch2_The_Assistant
{
	Chapter=2
	Rewards=Gold(4000),XP(5000)
	Stage0
	{
		State=Inactive
		OnStoryData:Kill_the_beest_quest_begin,keep
		{
			SetStage=5
		}
	}
	Stage5
	{
		State=Inactive
		Mark=new,terep_lair,Factory_engineer1,npc
		OnStoryData:Generator_plan_quest_failed,keep
		{
			SetStage=7
		}
		OnStoryData:Generator_plan_quest_begin,keep
		{
			SetStage=10
		}
	}
	Stage7
	{
		State=Hidden
	}
	Stage10
	{
		State=Active
		Mark=target,terep_csatorna_kiserletitelep,Dragan_Schimko,npc,main
		Onset
		{
			Mark=target,terep_csatorna_kiserletitelep,Assistant_start_Location,dummy,main
			Mark=Completed,terep_csatorna_kiserletitelep,Dragan_Schimko,npc,main
			HasStoryData:Generator_plan_done,equal,1
			{
				SetStage=20
			}
			HasStoryData:Von_Sturms_note,equal,1
			{
				AddStoryData=Generator_plan_done
			}
		}
		OnStoryData:Fulmigatis_note,keep
		{
			SetStage=15
		}
		OnStoryData:Blawatzky_notes,keep
		{
			SetStage=15
		}
		OnStoryData:Generator_plan_done,keep
		{
			SetStage=20
		}
	}
	Stage15
	{
		State=Active
		
		OnSet
		{
			Mark=none,terep_csatorna_kiserletitelep,Assistant_start_Location,dummy,main
			Mark=none,terep_csatorna_kiserletitelep,Dragan_Schimko,npc,main
			Mark=target,terep_lair,Assist_location,dummy,main
			Mark=Completed,terep_lair,Dragan_Schimko,npc,main
		}
		OnStoryData:Generator_plan_done,keep
		{
			SetStage=20
		}
	}
	Stage20
	{
		State=Completed
		OnSet
		{
			Mark=none,terep_csatorna_kiserletitelep,Assistant_start_Location,dummy,main
			Mark=none,terep_csatorna_kiserletitelep,Dragan_Schimko,npc,main
			Mark=none,terep_lair,Assist_location,dummy,main
			Mark=none,terep_lair,Dragan_Schimko,npc,main
		}
	}
}

Ch2_The_hidden_Treasure
{
	Chapter=2
	Rewards=Gold(2000),XP(2000)
	Stage0
	{
		State=Inactive
		OnStoryData:Hidden_treasure_quest_begin,keep
		{
			SetStage=5
		}
	}
	Stage5
	{
		State=Active
		Mark=target,terep_viztisztito_3,Hidden_treasure,npc,main
		OnSet
		{
			RemoveStoryData=Hidden_treasure_done
		}
		OnStoryData:Hidden_treasure_done,keep
		{
			SetStage=10
		}
	}
	Stage10
	{
		State=Completed
	}
}

Ch2_The_Beggar_King
{
	Chapter=2
	Rewards=Gold(1000),AbilityPoint(1),SkillPoint(1)
	Stage0
	{
		State=Inactive
		OnStoryData:Save_Beggar_King_begin,keep
		{
			SetStage=10
		}
	}
	Stage10
	{
		State=Active
		Mark=target,terep_ink_Beggarking,Beggar_king,npc,main
		OnSet
		{
			EnableEntrance=terep_viztisztito_2,Entrance_to_Beggar_Ink,true
		}
		OnSoldierGroupKilled:Beggar_King_hunters,terep_ink_Beggarking
		{
			AddStoryData=Beggar_King_hunters_killed
			SetStage=15
		}
	}
	Stage15
	{
		State=Active
		Mark=completed,terep_ink_Beggarking,Beggar_king,npc,main
		OnStoryData:Save_Beggar_King_done,keep
		{
			SetStage=20
		}
	}
	Stage20
	{
		State=Completed
	}
}

Ch2_Swamp_Flowers
{
	Chapter=2
	Rewards=Gold(2000),XP(2000),RandomItem(rarity:rare)
	Task
	{
		TaskID=talk
		State=Inactive
	}
	Task
	{
		TaskID=return
		State=Inactive
	}
	Stage0
	{
		State=Inactive
		OnStoryData:viztisztito_3_opened,keep
		{
			SetStage=5
		}
	}
	Stage5
	{
		State=Inactive
		Mark=new,terep_lair,Saffi,npc
		OnStoryData:Swamp_flowers_quest_begin,keep
		{
			SetStage=10
		}
		OnItemGot:swamp_flower
		{
			AddStoryData=Lair_witch_3
			AddStoryData=First_Swamp_Flower
			SetStage=7
		}
	}
	Stage7
	{
		Optional=1
		State=Active
		Mark=completed,terep_lair,Saffi,npc
		OnSet
		{
			SetTaskState=main,Hidden
			SetTaskState=talk,Active
		}
		OnStoryData:Swamp_flowers_quest_begin,keep
		{
			SetTaskState=talk,Completed
			SetTaskState=main,Active
			SetStage=10
		}
		OnItemGot:swamp_flower
		{
			ItemCount:swamp_flower,greater_equal,3
			{
				AddStoryData=third_swamp_flower
			}
			ItemCount:swamp_flower,greater_equal,5
			{
				AddStoryData=fifth_swamp_flower
			}
			ItemCount:swamp_flower,greater_equal,6
			{
				AddStoryData=sixth_swamp_flower
			}
			ItemCount:swamp_flower,greater_equal,8
			{
				AddStoryData=Eighth_swamp_flower
				AddStoryData=Lair_witch_4
				SetStage=15
			}
		}
	}
	Stage10
	{
		State=Active
		OnItemGot:swamp_flower
		{
			AddStoryData=First_Swamp_Flower
			ItemCount:swamp_flower,greater_equal,2
			{
				AddStoryData=second_swamp_flower
			}
			ItemCount:swamp_flower,greater_equal,4
			{
				AddStoryData=fourth_swamp_flower
			}
			ItemCount:swamp_flower,greater_equal,7
			{
				AddStoryData=seventh_swamp_flower
			}
			ItemCount:swamp_flower,greater_equal,8
			{
				AddStoryData=Eight_swamp_flower_collected
				SetStage=15
			}
		}
	}
	Stage15
	{
		State=Active
		Mark=completed,terep_lair,Saffi,npc
		OnSet
		{
			SetTaskState=main,Completed
			SetTaskState=return,Active
			SetTaskState=talk,Hidden
		}
		OnStoryData:Swamp_flower_quest_Done,keep
		{
			SetStage=20
		}
	}
	Stage20
	{
		State=Completed
	}
}

Ch2_The_weapon_shipment
{
	Chapter=2
	Rewards=Gold(5000),XP(5000),RandomItem(rarity:rare)
	Task
	{
		TaskID=Secure
		State=Inactive
	}
	Task
	{
		TaskID=Speak
		State=Inactive
	}
	Stage0
	{
		State=Inactive
		Mark=new,terep_viztisztito_3,wounded_soldier,npc
		OnStoryData:Reject_weapon_shipment,keep
		{
			EnableTrigger=terep_viztisztito_3,Wounded_soldier_dead,true
			SetStage=2
		}
		OnStoryData:Weapon_shipment_begin,keep
		{
			SetStage=5
		}
	}
	Stage2
	{
		State=Inactive
		OnStoryData:Wounded_soldier_dead,keep
		{
			SetStage=3
		}
	}
	Stage3
	{
		State=Hidden
	}
	Stage5
	{
		State=Active
		Mark=target,terep_viztisztito_3,Lighthouse_location,dummy,main
		OnStoryData:Lighthouse_signal_done,keep
		{
			SetTaskState=main,Completed
			SetTaskState=Secure,Active
			EnableTrigger=terep_viztisztito_3,Wounded_soldier_dead,true
			SetStage=10
		}
	}
	Stage10
	{
		State=Active
		Mark=target,terep_viztisztito_3,Weapon_shipment_location,dummy,Secure
		OnStoryData:Wounded_soldier_dead,keep
		{
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_1
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_1
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_1
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_1
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_1
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_2
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_2
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_2
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_2
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_2
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_3
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_3
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_3
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_3
			SpawnMonster=werewolf_electric_range,werewolf_electric_range,terep_viztisztito_3,Shipment_destroyer_3
			SetStage=15
		}
	}
	Stage15
	{
		State=Active
		Mark=target,terep_viztisztito_3,Weapon_shipment_location,dummy,Secure
		OnSoldierKilled:werewolf_electric_range,terep_viztisztito_3
		{
			CountSoldiers=terep_viztisztito_3,werewolf_electric_range,monsters_remaining
		}
		OnVariableChanged:monsters_remaining,0
		{
			AddStoryData=Killed_all_werewolf_nr
			
			SetStage=20
		}
	}
	Stage20
	{
		State=Active
		
		OnSet
		{
			Mark=target,terep_viztisztito_3,Weapon_shipment_location,dummy,Speak
			Mark=Completed,terep_viztisztito_3,Weapon_smuggler,npc,Speak
			SetTaskState=Secure,Completed
			SetTaskState=Speak,Active
		}
		OnStoryData:Weapon_shipment_quest_done,keep
		{
			SetStage=25
		}
	}
	Stage25
	{
		State=Completed
		OnSet
		{
			AddLoot=Weapon_smuggler_loot,terep_viztisztito_3,Weapon_shipment_location,dummy
			Mark=none,terep_viztisztito_3,Weapon_shipment_location,dummy,Speak
			Mark=none,terep_viztisztito_3,Weapon_smuggler,npc,Speak
		}
	}
}

Ch2_The_rival_mages
{
	Chapter=2
	Rewards=Gold(4000),XP(4000)
	Task
	{
		TaskID=go_back
		State=inactive
	}
	Stage0
	{
		State=Inactive
		OnStoryData:Water_purifier,keep
		{
				SetStage=5
		}
	}
	Stage5
	{
		State=Inactive
		Mark=new,terep_viztisztito_3,DLC_NPC_pale_gentleman,npc
		OnStoryData:The_rivalmages_quest_begin,keep
		{
			SetStage=10
		}
		OnStoryData:The_rivalmages_quest_failed,keep
		{
			SetStage=7
		}
	}
	Stage7
	{
		State=Hidden
	}
	Stage10
	{
		State=Active
		Mark=target,terep_viztisztito_3,Entrance_from_csatorna,dummy,main
		OnSet
		{
			EnableEntrance=terep_viztisztito_3,Entrance_to_mageslab,true
		}
		OnMapChanged:terep_csatorna_nekro
		{
			SetStage=15
		}
	}
	Stage15
	{
		State=Active
		OnSoldierKilledname:DLC_Magus_rivalquest,terep_csatorna_nekro
		{
			CountSoldiers=terep_csatorna_nekro,DLC_Magus_rivalquest,magus_remaining,name
		}
		OnVariableChanged:magus_remaining,0
		{
			SetStage=20
		}
	}
	Stage20
	{
		State=Active
		Mark=Completed,terep_viztisztito_3,DLC_NPC_pale_gentleman,npc
		OnSet
		{
			SetTaskState=main,Completed
			SetTaskState=go_back,Active
			AddStoryData=Rivalmages_dlg_enabled
		}
		OnStoryData:The_rivalmages_quest_done,keep
		{
			SetStage=25
		}
	}
	Stage25
	{
		State=Completed
	}
}
Ch2_The_test_machines
{
	Chapter=2
	Rewards=Gold(4000),XP(5000),RandomItem(rarity:rare)
	Stage0
	{
		State=Inactive
		OnStoryData:viztisztito_3_opened,keep
		{
			SetStage=5
		}
	}
	Stage5
	{
		State=Inactive
		Mark=new,terep_Lair,DLC_NPC_rebel_5,npc
		OnStoryData:The_testmachines_quest_begin,keep
		{
			SetStage=10
		}
		OnStoryData:The_testmachines_quest_failed,keep
		{
			SetStage=8
		}
		OnStoryData:Street_banters_done,keep
		{
			SetStage=7
		}
	}
	Stage7
	{
		State=Hidden
	}
	Stage8
	{
		State=Hidden
	}
	Stage10
	{
		State=Active
		Mark=target,terep_csatorna_hosszu,Testmachines_location,dummy,main
		OnMapChanged:terep_csatorna_hosszu
		{
			SetStage=15
		}
	}
	Stage15
	{
		State=Active
		Mark=target,terep_csatorna_hosszu,Testmachines_location,dummy,main
		OnSet
		{
			AddStoryData=rebel_5_kimozgato
			CheckSoldierAlive=test_machine,terep_csatorna_hosszu
		}
		OnSoldierKilledname:test_machine,terep_csatorna_hosszu
		{
			CountSoldiers=terep_csatorna_hosszu,test_machine,testmachine_remaining,name
		}
		OnVariableChanged:testmachine_remaining,0
		{
			SetStage=20
		}
	}
	Stage20
	{
		State=Completed
	}
}